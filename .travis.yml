language: php

os:
  - linux

env:
  matrix:
  - TARGET=cpp
  - TARGET=cs
  - TARGET=java
  - TARGET=js
  - TARGET=neko
  - TARGET=php
  - TARGET=swf

matrix:
  fast_finish: true

# Install Haxe and dependencies before running the test.
before_script:
  - git submodule update --init --recursive            # update utest
  - sudo add-apt-repository ppa:eyecreate/haxe -y      # add the ubuntu ppa that contains haxe
  - sudo apt-get update                                # pull info from ppa
  - sudo apt-get install haxe -y                       # install haxe (and neko)
  - mkdir ~/haxelib                                    # create a folder for installing haxelib
  - haxelib setup ~/haxelib
  - haxelib install utest                              # dependency
  - mkdir -p ./bin
  - sh -c "if [ '$TARGET' = 'cpp' ]; then sudo apt-get install gcc-multilib g++-multilib -y; fi"
  - sh -c "if [ '$TARGET' = 'cpp' ]; then haxelib install hxcpp; fi"
  - sh -c "if [ '$TARGET' = 'cs' ]; then sudo apt-get install mono-gmcs; fi"
  - sh -c "if [ '$TARGET' = 'cs' ]; then haxelib install hxcs; fi"
  - sh -c "if [ '$TARGET' = 'java' ]; then haxelib install hxjava; fi"
  - sh -c "if [ '$TARGET' = 'swf' ]; then wget http://fpdownload.macromedia.com/pub/flashplayer/updaters/11/flashplayer_11_sa_debug.i386.tar.gz; fi"
  - sh -c "if [ '$TARGET' = 'swf' ]; then tar xvzf flashplayer_11_sa_debug.i386.tar.gz; fi"
  - sh -c "if [ '$TARGET' = 'swf' ]; then export PATH=$PATH:~/bin/; fi"
  - sh -c "if [ '$TARGET' = 'swf' ]; then sh -e /etc/init.d/xvfb start; fi"

# Run the test!
script:
  - haxe hxml/thx.core.${TARGET}.hxml
  - sh -c "if [ '$TARGET' = 'swf' ]; then xvfb-run -a ./flashplayerdebugger bin/test.swf; fi"

branches:
  only:
    - master